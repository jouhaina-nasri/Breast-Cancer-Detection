<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700">
    <title>Breast Cancer Classification</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link rel="icon" href="{{ url_for('static', filename='img/logo.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/logo.png') }}">

    <!-- Bootstrap / jQuery -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

    <style>
        body {
          color: #999;
          background: #f3f3f3;
          font-family: 'Roboto', sans-serif;
        }

        #result{
          display: flex;
          flex-wrap: wrap;
          margin-left:200px;
          gap: 10px;
          padding: 10px 0;
        }

        #result .item {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-right: 15px;
        }

        #result img {
          max-width: 180px;
          max-height: 180px;
          object-fit: contain;
          border-radius: 4px;
          border: 1px solid #ddd;
          margin-bottom: 5px;
        }

        .form-control {
          border-color: #eee;
          min-height: 41px;
          box-shadow: none !important;
        }
        .form-control:focus {
          border-color: #5cd3b4;
        }
        .form-control, .btn {
          border-radius: 3px;
        }
        .signup-form {
          width: 500px;
          margin: 0 auto;
          padding: 30px 0;
        }
        .signup-form h2 {
          color: #333;
          margin: 0 0 30px 0;
          display: inline-block;
          padding: 0 30px 10px 0;
          border-bottom: 3px solid #5cd3b4;
        }
        .signup-form .form {
          color: #999;
          border-radius: 3px;
          margin-bottom: 15px;
          background: #fff;
          box-shadow: 0px 2px 2px rgba(0, 0, 0, 0.3);
          padding: 30px;
        }
        .signup-form .form-group row {
          margin-bottom: 20px;
        }
        .signup-form label {
          font-weight: normal;
          font-size: 14px;
          line-height: 2;
        }
        .signup-form .btn {
          font-size: 16px;
          font-weight: bold;
          background: #5cd3b4;
          border: none;
          margin-top: 20px;
          min-width: 140px;
        }
        .signup-form .btn:hover, .signup-form .btn:focus {
          background: #41cba9;
          outline: none !important;
        }

        .col-md {
          margin-left:150px;
        }

        /* MODAL */
        .modal {
          display: none;
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
          background-color: #fefefe;
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
        }

        .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
        }

        .close:hover,
        .close:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
        }
    </style>
</head>
<body>

<form class="signup-form" enctype="multipart/form-data">
    <div class="form">
        <div class="row">
            <div class="col-8 offset-4">
                <h2>Upload Test Images</h2>
            </div>
        </div>

        <div class="form-group row">
            <label class="col-form-label col-4">SELECT</label>
            <div class="col-8">
                <div class="custom-file">
                    <input type="file"
                           class="custom-file-input"
                           id="inputGroupFile01"
                           name="file"
                           accept="image/*"
                           multiple>
                    <label class="custom-file-label" for="inputGroupFile01">Choose images</label>
                </div>
            </div>
        </div>

        <div class="form-group row">
            <div class="col-md">
                <!-- IMPORTANT: type="button" to avoid submitting the HTML form -->
                <button type="button" class="btn btn-primary btn-lg" id="btn">Predict</button>
                <button type="button" class="btn btn-primary btn-lg" id="myBtn">Evaluate</button>
            </div>
        </div>

        <!-- Modal for global evaluation -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p id="evalText">Model evaluation on the test set:</p>
            </div>
        </div>

        <!-- Result zone: images + predictions -->
        <div id="result"></div>
    </div>
</form>

<script>
    // Display selected file names in the custom file input label
    $('#inputGroupFile01').on('change', function(){
        var fileName = $(this).val();
        $(this).next('.custom-file-label').html(fileName);
    });

    // ========= "Predict" button -> upload via fetch + display predictions =========
    window.onload = function () {
        var fileUpload = document.getElementById("inputGroupFile01");
        var btnTest = document.getElementById("btn");
        var resultDiv = document.getElementById("result");

        btnTest.onclick = function (e) {
            e.preventDefault();

            var files = fileUpload.files;
            if (!files || files.length < 1) {
                alert("Please select at least one image.");
                return;
            }

            // Preview images
            if (typeof (FileReader) != "undefined") {
                resultDiv.innerHTML = ""; // reset

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;

                    if (!regex.test(file.name.toLowerCase())) {
                        alert(file.name + " is not a valid image file.");
                        resultDiv.innerHTML = "";
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const item = document.createElement("div");
                        item.className = "item";

                        const img = document.createElement("img");
                        img.src = e.target.result;

                        const caption = document.createElement("p");
                        caption.innerText = file.name + " ...";

                        item.appendChild(img);
                        item.appendChild(caption);
                        resultDiv.appendChild(item);
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                alert("This browser does not support HTML5 FileReader.");
                return;
            }

            // Send images to backend /uploader
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append("file", files[i]);
            }

            fetch("/uploader", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // data.results = [ { filename, prediction, probability_normal }, ... ]
                const items = resultDiv.getElementsByClassName("item");

                data.results.forEach((res, index) => {
                    if (items[index]) {
                        const caption = items[index].querySelector("p");
                        if (res.error) {
                            caption.innerHTML = `
                                <b>${res.filename}</b><br>
                                Error: ${res.error}
                            `;
                        } else {
                            const prob = (res.probability_normal * 100).toFixed(2);
                            caption.innerHTML = `
                                Prediction: <b>${res.prediction}</b><br>
                                Probability of being <b>Normal</b>: ${prob}%
                            `;
                        }
                    }
                });
            })
            .catch(err => {
                alert("Error during prediction: " + err);
            });
        };
    };
</script>

<script>
    // ========= "Evaluate" button -> /evaluate + confusion matrix in modal =========
    var modal = document.getElementById("myModal");
    var btnEval = document.getElementById("myBtn");
    var span = document.getElementsByClassName("close")[0];
    var evalText = document.getElementById("evalText");

    btnEval.onclick = function () {
        fetch("/evaluate")
            .then(response => response.json())
            .then(data => {
                const acc = (data.accuracy * 100).toFixed(2);
                evalText.innerHTML =
                    "Accuracy on the test set: <b>" + acc + "%</b><br><br>" +
                    "<b>Confusion matrix</b><br>" +
                    "TN (true Cancer correctly classified as Cancer): " + data.tn + "<br>" +
                    "FP (Cancer misclassified as Normal): " + data.fp + "<br>" +
                    "FN (Normal misclassified as Cancer): " + data.fn + "<br>" +
                    "TP (true Normal correctly classified as Normal): " + data.tp + "<br><br>" +
                    "Total number of images: " + data.n_samples;

                modal.style.display = "block";
            })
            .catch(err => {
                evalText.textContent = "Error during evaluation: " + err;
                modal.style.display = "block";
            });
    };

    span.onclick = function () {
        modal.style.display = "none";
    };

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    };
</script>

</body>
</html>
